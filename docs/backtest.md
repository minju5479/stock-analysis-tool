# 🧪 백테스트 시스템 상세 가이드

## 📋 개요

본 주식 분석 도구의 백테스트 시스템은 **현실적이고 신뢰성 있는** 거래 전략 성과 평가를 제공합니다. 룩어헤드 바이어스를 방지하고 실제 거래 비용을 반영하여 과최적화된 결과를 방지합니다.

---

## 🔄 백테스트 프로세스

### 1. **데이터 준비**
```python
# 가격 데이터 조회 및 전처리
df = asyncio.run(get_processed_df_async(ticker, period))
# → OHLCV 데이터 + 30+ 기술지표가 포함된 DataFrame
```

**포함되는 데이터:**
- **기본 데이터**: Open, High, Low, Close, Volume
- **기술적 지표**: RSI, MACD, 볼린저밴드, 이동평균선 등
- **파생 지표**: Daily_Return, Volatility, ATR 등

### 2. **전략 신호 생성**
```python
# 선택된 전략에 따른 신호 생성
if selected_strategy["name"] == "rule_based":
    strategy = RuleBasedStrategy()
elif selected_strategy["name"] == "momentum":
    strategy = MomentumStrategy()
# ... 기타 전략들

signals = strategy.compute_signals(df, params=params)
```

**신호 DataFrame 구조:**
| Column | Type | Description |
|--------|------|-------------|
| date | DatetimeIndex | 신호 발생일 |
| action | str | BUY/SELL/HOLD |
| confidence | float | 신뢰도 (0~1) |
| reason | str | 신호 근거 |
| stop | float | 손절가 |
| target | float | 목표가 |
| size | float | 포지션 크기 |

### 3. **백테스트 실행**
```python
engine = BacktestEngine()
trades, equity = engine.run(
    df,                    # 가격 데이터
    signals,              # 매매 신호
    fee_bps=10.0,        # 수수료 (basis points)
    slippage_bps=10.0    # 슬리피지 (basis points)
)
```

---

## ⚙️ 백테스트 엔진 상세

### **체결 시스템**

#### 📅 **타이밍 규칙**
- **신호 발생**: T일 종가 기준으로 신호 생성
- **실제 체결**: T+1일 **시가(Open)**에서 체결
- **평가**: 매일 종가 기준으로 포트폴리오 가치 평가

```
Day 1 종가 → BUY 신호 생성
Day 2 시가 → 실제 매수 체결
Day 2 종가 → 포트폴리오 평가
```

#### 💰 **가격 체결 모델**
```python
# 매수 시: 불리한 가격에 체결
fill_price = open_price * (1 + (fee_bps + slippage_bps) / 10000)

# 매도 시: 불리한 가격에 체결  
fill_price = open_price * (1 - (fee_bps + slippage_bps) / 10000)
```

**비용 구성:**
- **수수료 (Fee)**: 거래소/브로커 수수료
- **슬리피지 (Slippage)**: 시장 충격 비용

### **포지션 관리**

#### 📈 **포지션 타입**
- **롱 온리**: 매수/현금 보유만 (공매도 미지원)
- **전액 투자**: 신호 발생 시 전체 자본으로 매수/매도
- **상태 전환**: CASH ↔ LONG

#### 🔄 **포지션 전환 로직**
```python
# 현재 상태: CASH
if signal == "BUY":
    # 전체 현금으로 주식 매수
    position = "LONG"
    shares = cash / fill_price
    cash = 0

# 현재 상태: LONG  
if signal == "SELL":
    # 전체 주식 매도
    position = "CASH"
    cash = shares * fill_price
    shares = 0
```

---

## 🎯 지원되는 전략

### 🔸 **룰베이스 전략 (Rule-Based)**
**분석 기법**: MA + RSI + MACD 조합

**매매 규칙:**
- **매수**: 상승추세 + RSI 과매도 + MACD 골든크로스
- **매도**: 하락추세 + RSI 과매수 + MACD 데드크로스

**파라미터:**
- `rsi_buy_threshold`: RSI 매수 기준 (기본값: 30)
- `rsi_sell_threshold`: RSI 매도 기준 (기본값: 70)
- `risk_reward_ratio`: 리스크-리워드 비율 (기본값: 2.0)

### 🔸 **모멘텀 전략 (Momentum)**
**분석 기법**: 가격 모멘텀 + 거래량 + 브레이크아웃

**매매 규칙:**
- **매수**: 강한 상승 모멘텀 + 고거래량 또는 고점 돌파
- **매도**: 약한 하락 모멘텀 + 고거래량 또는 저점 이탈

**파라미터:**
- `momentum_period`: 모멘텀 계산 기간 (기본값: 20)
- `breakout_threshold`: 브레이크아웃 임계값 (기본값: 0.02)
- `volume_sma`: 거래량 이동평균 (기본값: 10)

### 🔸 **평균회귀 전략 (Mean Reversion)**
**분석 기법**: 볼린저밴드 + RSI 극값

**매매 규칙:**
- **매수**: RSI 과매도 + 볼린저밴드 하단 + 낮은 변동성
- **매도**: RSI 과매수 + 볼린저밴드 상단

**파라미터:**
- `bb_period`: 볼린저밴드 기간 (기본값: 20)
- `bb_std`: 볼린저밴드 표준편차 (기본값: 2.0)
- `rsi_oversold`: RSI 과매도 기준 (기본값: 25)
- `rsi_overbought`: RSI 과매수 기준 (기본값: 75)

### 🔸 **패턴인식 전략 (Pattern Recognition)**
**분석 기법**: 차트 패턴 + 지지저항 + 브레이크아웃

**매매 규칙:**
- **매수**: 더블바텀 후 지지선 돌파 또는 삼각형 패턴 브레이크아웃
- **매도**: 더블톱 후 저항선 이탈 또는 지지선 붕괴

**파라미터:**
- `pattern_window`: 패턴 감지 윈도우 (기본값: 10)
- `support_resistance_window`: 지지저항 윈도우 (기본값: 20)
- `breakout_threshold`: 브레이크아웃 임계값 (기본값: 0.01)

---

## 📊 성과 지표

### **주요 지표들**

#### 💹 **CAGR (연평균 복리수익률)**
```python
CAGR = (최종가치 / 초기가치) ^ (1 / 연수) - 1
```
- **해석**: 연간 평균 수익률
- **좋은 값**: 시장 수익률(S&P 500: ~10%) 이상

#### 📈 **Volatility (변동성)**
```python
Volatility = 일간수익률의 표준편차 * sqrt(252)
```
- **해석**: 연간 변동성 (위험도)
- **좋은 값**: 낮을수록 안정적

#### ⚖️ **Sharpe Ratio (샤프 비율)**
```python
Sharpe = (CAGR - 무위험수익률) / Volatility
```
- **해석**: 위험 대비 수익률
- **좋은 값**: 1.0 이상 우수, 2.0 이상 매우 우수

#### 📉 **Max Drawdown (최대 낙폭)**
```python
MaxDD = max((Peak - Trough) / Peak)
```
- **해석**: 최고점 대비 최대 하락폭
- **좋은 값**: -20% 이내 양호

### **결과 해석 가이드**

| 지표 | 우수 | 양호 | 보통 | 주의 |
|------|------|------|------|------|
| CAGR | >15% | 10-15% | 5-10% | <5% |
| Sharpe | >2.0 | 1.0-2.0 | 0.5-1.0 | <0.5 |
| Max DD | <-10% | -10~-20% | -20~-30% | >-30% |
| Volatility | <15% | 15-25% | 25-35% | >35% |

---

## ⚙️ 파라미터 시스템

### **공통 파라미터**

#### 🏃 **워밍업 기간 (Warmup Period)**
- **목적**: 지표 안정화를 위한 초기 구간 제외
- **범위**: 0~200일
- **권장값**: 50일 (중립), 20일 (공격적), 100일 (보수적)

#### 💳 **거래 비용**
- **수수료 (Fee)**: 0~50 bps
- **슬리피지 (Slippage)**: 0~50 bps
- **총 비용**: (수수료 + 슬리피지) × 2 (매수+매도)

### **프리셋 시스템**

#### 🛡️ **보수적 프리셋**
```python
{
    "warmup": 100,         # 긴 워밍업
    "rsi_buy": 25,         # 더 과매도
    "rsi_sell": 75,        # 더 과매수
    "risk_rr": 1.5,        # 낮은 리스크-리워드
    "fee_bps": 15,         # 높은 비용 가정
    "slippage_bps": 15
}
```

#### ⚖️ **중립 프리셋**
```python
{
    "warmup": 50,          # 보통 워밍업
    "rsi_buy": 30,         # 표준 과매도
    "rsi_sell": 70,        # 표준 과매수  
    "risk_rr": 2.0,        # 표준 리스크-리워드
    "fee_bps": 10,         # 보통 비용
    "slippage_bps": 10
}
```

#### ⚡ **공격적 프리셋**
```python
{
    "warmup": 20,          # 짧은 워밍업
    "rsi_buy": 35,         # 덜 과매도
    "rsi_sell": 65,        # 덜 과매수
    "risk_rr": 2.5,        # 높은 리스크-리워드
    "fee_bps": 8,          # 낮은 비용 가정
    "slippage_bps": 8
}
```

---

## 📈 결과 분석

### **거래 내역 (Trades)**

**컬럼 구조:**
- `date`: 체결일
- `action`: BUY/SELL
- `price`: 체결가격
- `shares`: 거래량
- `value`: 거래대금
- `pnl`: 손익 (매도시)
- `pnl_pct`: 손익률

### **자산 곡선 (Equity Curve)**

**컬럼 구조:**
- `date`: 날짜
- `equity`: 총 자산 가치
- `position`: 포지션 (CASH/LONG)
- `shares`: 보유 주식 수
- `cash`: 현금

### **시각화**
- **자산 곡선**: 시간별 포트폴리오 가치 변화
- **수익률 분포**: 일간 수익률 히스토그램
- **드로우다운**: 최고점 대비 하락폭 추이

---

## ⚠️ 주의사항 및 한계

### **현재 구현의 한계**

#### 📍 **포지션 제약**
- **롱 온리**: 공매도 미지원
- **전액 투자**: 부분 매매 미지원 (0% 또는 100%)
- **단일 종목**: 포트폴리오/분산투자 미지원

#### 📍 **체결 모델 단순화**
- **시가 체결**: 지정가 주문 미지원
- **무제한 유동성**: 대량 거래시 시장 충격 미고려
- **갭 리스크**: 급격한 가격 변동 미반영

#### 📍 **비용 모델**
- **고정 비용**: 거래 규모별 차등 수수료 미반영
- **세금 미고려**: 양도소득세, 배당소득세 등 제외

### **백테스트 결과 해석 시 고려사항**

#### 🎯 **과최적화 (Overfitting) 방지**
- 파라미터를 과도하게 조정하면 과거 데이터에만 맞는 결과 도출
- **권장**: 기본 프리셋으로 먼저 테스트

#### 📊 **표본 편향 (Sample Bias)**
- 특정 기간에만 좋은 성과를 보일 수 있음
- **권장**: 다양한 기간(1y, 2y, 5y)으로 테스트

#### 🌍 **시장 환경 변화**
- 과거 성과가 미래 성과를 보장하지 않음
- **권장**: 최근 데이터 위주로 검증

---

## 🛠️ 개선 계획

### **단기 개선사항**
- [ ] 부분 매매 지원 (포지션 크기 조절)
- [ ] 다양한 주문 타입 (지정가, 손절매)
- [ ] 슬리피지 모델 개선

### **중기 개선사항**
- [ ] 공매도 지원
- [ ] 포트폴리오 백테스트
- [ ] 섹터/지역별 분석

### **장기 개선사항**
- [ ] 머신러닝 기반 전략
- [ ] 대안투자 자산 지원
- [ ] 리스크 관리 시스템

---

## 📚 사용법 요약

### **빠른 시작**

1. **전략 선택**: 룰베이스/모멘텀/평균회귀/패턴인식 중 선택
2. **프리셋 적용**: 보수적/중립/공격적 중 선택  
3. **기간 설정**: 1개월~5년 범위에서 선택
4. **분석 실행**: 결과를 통한 성과 검증

### **파라미터 튜닝 팁**

- **초보자**: 중립 프리셋으로 시작
- **단기 트레이딩**: 공격적 프리셋 + 짧은 기간
- **중장기 투자**: 보수적 프리셋 + 긴 기간
- **고빈도 거래**: 낮은 수수료/슬리피지 설정

### **결과 해석**

- **CAGR > 10%**: 시장 대비 우수한 성과
- **Sharpe > 1.0**: 위험 대비 양호한 수익
- **Max DD < -20%**: 감내 가능한 위험 수준

---

## 💡 결론

본 백테스트 시스템은 **현실적이고 신뢰성 있는** 전략 검증 도구입니다. 룩어헤드 바이어스 방지와 실제 거래 비용 반영을 통해 과최적화를 방지하고, 다양한 전략과 파라미터 조합을 통해 사용자 맞춤형 분석을 제공합니다.

**핵심 장점:**
- ✅ 4가지 서로 다른 분석 기법
- ✅ 현실적인 체결 모델
- ✅ 포괄적인 성과 지표
- ✅ 직관적인 파라미터 컨트롤

백테스트 결과를 실제 투자에 활용할 때는 시장 환경 변화와 개인의 리스크 허용도를 고려하여 신중하게 판단하시기 바랍니다.
